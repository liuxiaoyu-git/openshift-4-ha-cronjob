#!/usr/bin/env ansible-playbook
- hosts: localhost
  gather_facts: false
  vars:
    THIS_CLUSTER_URL: https://api.ocp42.currys.cloud:6443
    ALTERNATE_CLUSTER_URL: https://api.ocp42.currys.cloud:6443
    SA_TOKEN: Xjw2-NJ7GzOsUOHmf0kKf8U_ImtPMLlFBdJaNM3BQDo
    DC_NAME: httpd-example
    PROJECT_NAME: app-a
    STANDARD_REPLICAS: 1
    DISASTER_REPLICAS: 5
  tasks:
  - name: Check alternate cluster status
    uri:
      url: "{{ ALTERNATE_CLUSTER_URL }}/healthz"
      validate_certs: no
      return_content: yes
    register: get_cluster_status

  - name: Alternate cluster is not reporting healthy
    block:
    - name: Log in to this cluster
      shell: "/usr/bin/oc
              login
              --insecure-skip-tls-verify
              --token={{ SA_TOKEN }}
              --server={{ THIS_CLUSTER_URL }}"

    - name: Get current application scale
      shell: "/usr/bin/oc
              get
              dc/{{ DC_NAME }}
              -o yaml
              -n {{ PROJECT_NAME }}"
      register: oc_get_dc

    - name: Scale application if necessary
      shell: "/usr/bin/oc
              scale
              dc/{{ DC_NAME }}
              --replicas {{ DISASTER_REPLICAS }}
              -n {{ PROJECT_NAME }}"
      when: (oc_get_dc.stdout | from_yaml).status.replicas != {{ DISASTER_REPLICAS }}
    when: get_cluster_status.content != 'ok'

  - name: Alternate cluster is reporting healthy
    block:
    - name: Log in to this cluster
      shell: "/usr/bin/oc
              login
              --insecure-skip-tls-verify
              --token={{ SA_TOKEN }}
              --server={{ THIS_CLUSTER_URL }}"

    - name: Get current application scale
      shell: "/usr/bin/oc
              get
              dc/{{ DC_NAME }}
              -o yaml
              -n {{ PROJECT_NAME }}"
      register: oc_get_dc

    - name: Scale application if necessary
      shell: "/usr/bin/oc
              scale
              dc/{{ DC_NAME }}
              --replicas {{ DISASTER_REPLICAS }}
              -n {{ PROJECT_NAME }}"
      when: (oc_get_dc.stdout | from_yaml).status.replicas != {{ STANDARD_REPLICAS }}
    when: get_cluster_status.content == 'ok'
